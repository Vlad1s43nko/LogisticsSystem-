{% extends "base.html" %}

{% block title %}Trip Details - Logistics Management System{% endblock %}

{% block trips_active %}active{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Trip Details</h1>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="/trips">Trips</a></li>
            <li class="breadcrumb-item active" aria-current="page">Trip {{ trip_id }}</li>
        </ol>
    </nav>
</div>

<div id="tripDetailRoot" data-trip-id="{{ trip_id }}"></div>
{% endblock %}

{% block scripts %}
<script type="text/babel">
{% raw %}
// TripDetail Component
const TripDetailComponent = () => {
    const { useState, useEffect } = React;
    
    // Get trip ID from the DOM
    const tripId = document.getElementById('tripDetailRoot').getAttribute('data-trip-id');
    
    // State for trip data
    const [trip, setTrip] = useState(null);
    const [truck, setTruck] = useState(null);
    const [newNote, setNewNote] = useState('');
    const [tripNotes, setTripNotes] = useState([]);
    
    // Trip milestones in Ukrainian
    const milestones = [
        { id: 'departed', label: 'Машина вирушила', completed: true },
        { id: 'loading', label: 'Завантаження на складі', completed: true },
        { id: 'border', label: 'Прямує до кордону', completed: true },
        { id: 'destination', label: 'Прямує до точки призначення', completed: false },
        { id: 'arrived', label: 'Машина прибула', completed: false }
    ];
    
    // Find the current milestone (first non-completed one)
    const currentMilestoneIndex = milestones.findIndex(milestone => !milestone.completed);
    
    // Function to get milestone status
    const getMilestoneStatus = (index) => {
        if (milestones[index].completed) return 'completed';
        if (index === currentMilestoneIndex) return 'current';
        return 'pending';
    };
    
    useEffect(() => {
        // Find the trip across all trucks
        let foundTrip = null;
        let foundTruck = null;
        
        for (const truckData of window.dummyData.trucks) {
            if (truckData.trips) {
                const trip = truckData.trips.find(t => t.id === tripId);
                if (trip) {
                    foundTrip = trip;
                    foundTruck = truckData;
                    break;
                }
            }
            
            // Check current trips
            if (truckData.status === 'In Trip' && truckData.currentTrip) {
                const currentTripId = `CURRENT_${truckData.id}`;
                if (currentTripId === tripId) {
                    foundTrip = {
                        id: currentTripId,
                        direction: truckData.currentTrip.direction,
                        driver: truckData.currentDriver,
                        cargo: truckData.currentTrip.cargo,
                        cost: truckData.currentTrip.cost,
                        status: 'In Progress',
                        startDate: '2025-06-01',
                        endDate: 'TBD',
                        client: 'Current Client',
                        startKm: 120000,
                        endKm: 'TBD',
                        days: 'In Progress'
                    };
                    foundTruck = truckData;
                    break;
                }
            }
        }
        
        if (foundTrip && foundTruck) {
            setTrip(foundTrip);
            setTruck(foundTruck);
        }
        
        // Initialize sample notes
        setTripNotes([
            {
                id: 1,
                date: '2025-04-01 08:30',
                author: 'Dispatcher',
                text: 'Trip started on schedule. All documentation checked.'
            },
            {
                id: 2,
                date: '2025-04-01 14:15',
                author: 'Driver',
                text: 'Loading completed successfully. Ready to depart.'
            }
        ]);
    }, [tripId]);
    
    // Handle adding a new note
    const handleAddNote = () => {
        if (newNote.trim()) {
            const note = {
                id: tripNotes.length + 1,
                date: new Date().toLocaleString('uk-UA'),
                author: 'Current User',
                text: newNote
            };
            setTripNotes([...tripNotes, note]);
            setNewNote('');
        }
    };
    
    if (!trip || !truck) {
        return <div className="loading">Loading trip data...</div>;
    }
    
    return (
        <div className="trip-detail-container">
            {/* Trip Progress Milestones - Wide but Compact */}
            <div className="milestones-section-compact">
                <div className="milestones-header">
                    <h4>Trip Progress - {trip.direction}</h4>
                </div>
                <div className="milestones-container-compact">
                    {milestones.map((milestone, index) => {
                        const status = getMilestoneStatus(index);
                        const nextStatus = index < milestones.length - 1 ? getMilestoneStatus(index + 1) : 'pending';
                        
                        return (
                            <div key={milestone.id} className="milestone-wrapper-compact">
                                <div className={`milestone-item-compact ${status}`}>
                                    <div className="milestone-icon-compact">
                                        <i className={status === 'completed' ? 'fas fa-check' : 'far fa-clock'}></i>
                                    </div>
                                    <div className="milestone-label-compact">
                                        {milestone.label}
                                    </div>
                                </div>
                                {index < milestones.length - 1 && (
                                    <div className={`milestone-arrow-compact ${nextStatus}`}>
                                        <i className="fas fa-chevron-right"></i>
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>
            </div>
            
            {/* Interactive Map Section */}
            <div className="map-section">
                <div className="card">
                    <div className="card-header">
                        <h5>Current Location - {truck.licensePlate}</h5>
                    </div>
                    <div className="card-body">
                        <div className="trip-map-placeholder">
                            <MapComponent 
                            type="trip" 
                            data={trip} 
                            height={350} 
                            />
                        </div>
                    </div>
                </div>
            </div>
            
            {/* Main Trip Information Section */}
            <div className="trip-info-section">
                <div className="card">
                    <div className="card-header">
                        <h5>Trip Information</h5>
                    </div>
                    <div className="card-body">
                        <div className="row">
                            <div className="col-md-6">
                                <table className="table table-sm">
                                    <tbody>
                                        <tr>
                                            <th>Trip ID</th>
                                            <td>{trip.id}</td>
                                        </tr>
                                        <tr>
                                            <th>Direction</th>
                                            <td>{trip.direction}</td>
                                        </tr>
                                        <tr>
                                            <th>Driver</th>
                                            <td>{trip.driver}</td>
                                        </tr>
                                        <tr>
                                            <th>Truck</th>
                                            <td>
                                                <a href={`/truck/${truck.id}`} className="truck-link">
                                                    {truck.licensePlate}
                                                </a>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Cargo</th>
                                            <td>{trip.cargo}</td>
                                        </tr>
                                        <tr>
                                            <th>Client</th>
                                            <td>{trip.client}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div className="col-md-6">
                                <table className="table table-sm">
                                    <tbody>
                                        <tr>
                                            <th>Start Date</th>
                                            <td>{trip.startDate}</td>
                                        </tr>
                                        <tr>
                                            <th>End Date</th>
                                            <td>{trip.endDate}</td>
                                        </tr>
                                        <tr>
                                            <th>Start Kilometrage</th>
                                            <td>{trip.startKm} km</td>
                                        </tr>
                                        <tr>
                                            <th>End Kilometrage</th>
                                            <td>{trip.endKm} km</td>
                                        </tr>
                                        <tr>
                                            <th>Distance</th>
                                            <td>{trip.endKm !== 'TBD' ? (trip.endKm - trip.startKm) + ' km' : 'TBD'}</td>
                                        </tr>
                                        <tr>
                                            <th>Trip Days</th>
                                            <td>{trip.days}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            {/* Financial Information Section */}
            <div className="trip-additional-info-section">
                <div className="card">
                    <div className="card-header">
                        <h5>Financial Information</h5>
                    </div>
                    <div className="card-body">
                        <div className="row">
                            <div className="col-md-6">
                                <table className="table table-sm">
                                    <tbody>
                                        <tr>
                                            <th>Fuel Consumed</th>
                                            <td>{trip.fuelConsumed || 'TBD'} l</td>
                                        </tr>
                                        <tr>
                                            <th>Fuel Cost</th>
                                            <td>{trip.fuelCost || 'TBD'} €</td>
                                        </tr>
                                        <tr>
                                            <th>Cost per Liter</th>
                                            <td>{trip.costPerLiter || 'TBD'} €</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div className="col-md-6">
                                <table className="table table-sm">
                                    <tbody>
                                        <tr>
                                            <th>Trip Cost</th>
                                            <td>{trip.cost} €</td>
                                        </tr>
                                        <tr>
                                            <th>Other Expenses</th>
                                            <td>{trip.otherExpenses || 'TBD'} €</td>
                                        </tr>
                                        <tr>
                                            <th>Total Expenses</th>
                                            <td>{trip.totalExpenses || 'TBD'} €</td>
                                        </tr>
                                        <tr className="profit-summary-row">
                                            <th>Profit</th>
                                            <td className={trip.profit && trip.profit > 0 ? 'text-success' : trip.profit < 0 ? 'text-danger' : ''}>
                                                {trip.profit || 'TBD'} €
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            {/* Trip Notes Section */}
            <div className="notes-section mt-4">
                <div className="card">
                    <div className="card-header">
                        <h5>Trip Notes</h5>
                    </div>
                    <div className="card-body">
                        <div className="notes-list">
                            {tripNotes.length > 0 ? (
                                tripNotes.map((note) => (
                                    <div className="note-item" key={note.id}>
                                        <div className="note-header">
                                            <span className="note-date">{note.date}</span>
                                            <span className="note-author">{note.author}</span>
                                        </div>
                                        <div className="note-content">
                                            {note.text}
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <div className="no-notes">
                                    <p>No notes available for this trip.</p>
                                </div>
                            )}
                        </div>
                        <div className="add-note mt-3">
                            <textarea 
                                className="form-control" 
                                rows="3" 
                                placeholder="Add a new note about this trip..." 
                                value={newNote}
                                onChange={(e) => setNewNote(e.target.value)}
                            ></textarea>
                            <button 
                                className="btn btn-primary mt-2" 
                                onClick={handleAddNote}
                                disabled={!newNote.trim()}
                            >
                                Add Note
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

try {
    // Render the TripDetail component
    ReactDOM.render(
        <TripDetailComponent />,
        document.getElementById('tripDetailRoot')
    );
} catch (error) {
    console.error("Error rendering TripDetail component:", error);
    document.getElementById('tripDetailRoot').innerHTML = `
        <div class="alert alert-danger">
            <h4>Error Loading Trip Details</h4>
            <p>${error.message}</p>
        </div>
    `;
}
{% endraw %}
</script>
{% endblock %}