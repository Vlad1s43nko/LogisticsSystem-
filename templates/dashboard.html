{% extends "base.html" %}

{% block title %}Dashboard - Logistics Management System{% endblock %}

{% block dashboard_active %}active{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Dashboard</h1>
</div>

<div id="dashboardRoot"></div>
{% endblock %}

{% block scripts %}
<script type="text/babel">
{% raw %}
// Dashboard Component
const DashboardComponent = () => {
    const { useState, useEffect } = React;

    // State for filters
    const [dateRange, setDateRange] = useState({ start: '', end: '' });
    const [direction, setDirection] = useState('all');
    const [driver, setDriver] = useState('all');
    const [truck, setTruck] = useState('all');
    const [showGraph, setShowGraph] = useState(false);
    
    // Track if filters are active
    const [filtersActive, setFiltersActive] = useState({
        dateRange: false,
        direction: false,
        driver: false,
        truck: false
    });
    
    // Function to update indicator visibility
    const updateIndicators = () => {
        // Start date indicator
        const startDateIndicator = document.getElementById('start-date-indicator');
        if (startDateIndicator) {
            startDateIndicator.style.opacity = dateRange.start ? '1' : '0';
        }
        
        // End date indicator
        const endDateIndicator = document.getElementById('end-date-indicator');
        if (endDateIndicator) {
            endDateIndicator.style.opacity = dateRange.end ? '1' : '0';
        }
        
        // Direction indicator
        const directionIndicator = document.getElementById('direction-indicator');
        if (directionIndicator) {
            directionIndicator.style.opacity = (direction !== 'all') ? '1' : '0';
        }
        
        // Driver indicator
        const driverIndicator = document.getElementById('driver-indicator');
        if (driverIndicator) {
            driverIndicator.style.opacity = (driver !== 'all') ? '1' : '0';
        }
        
        // Truck indicator
        const truckIndicator = document.getElementById('truck-indicator');
        if (truckIndicator) {
            truckIndicator.style.opacity = (truck !== 'all') ? '1' : '0';
        }
    };
    
    // Format large numbers with k (thousands) and M (millions) notation
    const formatNumber = (value) => {
        if (!value) return '0';
        
        // Remove commas if present
        const num = typeof value === 'string' ? parseFloat(value.replace(/,/g, '')) : value;
        
        if (num >= 1000000) {
            return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
        } else if (num >= 1000) {
            return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
        } else {
            return num.toString();
        }
    };

    // State for dashboard data (will come from dummyData)
    const [dashboardData, setDashboardData] = useState({});
    const [trucks, setTrucks] = useState([]);

    useEffect(() => {
        // Load data from dummyData
        setDashboardData(window.dummyData.dashboardSummary);
        setTrucks(window.dummyData.trucks);
        
        // Initialize the profit/loss chart
        if (showGraph) {
            const ctx = document.getElementById('profitLossChart');
            if (ctx) {
                window.initProfitLossChart(ctx, window.dummyData.profitLossData);
            }
        }
        
        // Set up a timer to check for indicators after component mount
        const timer = setTimeout(updateIndicators, 100);
        return () => clearTimeout(timer);
    }, [showGraph]);

    // Handle filter changes
    const handleFilterChange = () => {
        console.log("Filters applied:", { dateRange, direction, driver, truck });
        // Update active filter states
        setFiltersActive({
            dateRange: dateRange.start !== '' || dateRange.end !== '',
            direction: direction !== 'all',
            driver: driver !== 'all',
            truck: truck !== 'all'
        });
        
        // Update indicator visibility
        setTimeout(updateIndicators, 50); // Small timeout to ensure DOM is ready
    };
    
    // Reset all filters
    const handleResetFilters = () => {
        setDateRange({ start: '', end: '' });
        setDirection('all');
        setDriver('all');
        setTruck('all');
        setFiltersActive({
            dateRange: false,
            direction: false,
            driver: false,
            truck: false
        });
        
        // Hide all indicators
        setTimeout(() => {
            const indicators = document.querySelectorAll('.filter-active-indicator');
            indicators.forEach(indicator => {
                indicator.style.opacity = '0';
            });
        }, 50);
    };

    return (
        <div className="dashboard-container">
            {/* Summary Data Section */}
            <div className="summary-section">
                <div className="dashboard-card-container">
                    <div className="dashboard-card">
                        <div className="summary-card">
                            <div className="card-icon">
                                <i className="fas fa-circle-notch"></i>
                            </div>
                            <div className="card-content">
                                <h3>Витрата на 1 км</h3>
                                <div className="card-value">{dashboardData.fuelPerKm || '0'} € / км</div>
                            </div>
                        </div>
                    </div>
                    <div className="dashboard-card">
                        <div className="summary-card">
                            <div className="card-icon">
                                <i className="fas fa-road"></i>
                            </div>
                            <div className="card-content">
                                <h3>Пробіг (км)</h3>
                                <div className="card-value">{formatNumber(dashboardData.totalDistance) || '0'} км</div>
                            </div>
                        </div>
                    </div>
                    <div className="dashboard-card">
                        <div className="summary-card">
                            <div className="card-icon">
                                <i className="fas fa-money-bill-wave"></i>
                            </div>
                            <div className="card-content">
                                <h3>Фінансова динаміка</h3>
                                <div className="card-value">
                                    <span className="text-success">{dashboardData.financialDynamics || '0'} €</span> / <span className="text-danger">1 €</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div className="dashboard-card">
                        <div className="summary-card">
                            <div className="card-icon">
                                <i className="fas fa-chart-line"></i>
                            </div>
                            <div className="card-content">
                                <h3>Чистий прибуток</h3>
                                <div className="card-value">{formatNumber(dashboardData.netProfit) || '0'} €</div>
                            </div>
                        </div>
                    </div>
                    <div className="dashboard-card">
                        <div className="summary-card">
                            <div className="card-icon">
                                <i className="fas fa-file-invoice-dollar"></i>
                            </div>
                            <div className="card-content">
                                <h3>Витрати</h3>
                                <div className="card-value">{formatNumber(dashboardData.expenses) || '0'} €</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            {/* Filters Section */}
            <div className="filters-section">
                <div className="row align-items-end">
                    <div className="col-md-8">
                        <div className="row">
                            <div className="col">
                                <label>Date Range</label>
                                <div className="d-flex gap-2">
                                    <div className="filter-container date-input-container">
                                        <input 
                                            id="start-date-input"
                                            type="text" 
                                            className="filter-input"
                                            placeholder="mm/dd/yyyy"
                                            value={dateRange.start}
                                            onChange={(e) => setDateRange({...dateRange, start: e.target.value})}
                                        />
                                        <div 
                                            id="start-date-indicator"
                                            className="filter-active-indicator" 
                                            title={`Start date: ${dateRange.start}`}
                                        ></div>
                                    </div>
                                    <div className="filter-container date-input-container">
                                        <input 
                                            id="end-date-input"
                                            type="text" 
                                            className="filter-input"
                                            placeholder="mm/dd/yyyy"
                                            value={dateRange.end}
                                            onChange={(e) => setDateRange({...dateRange, end: e.target.value})}
                                        />
                                        <div 
                                            id="end-date-indicator"
                                            className="filter-active-indicator" 
                                            title={`End date: ${dateRange.end}`}
                                        ></div>
                                    </div>
                                </div>
                            </div>
                            <div className="col">
                                <label>Direction</label>
                                <div className="filter-container">
                                    <select 
                                        className="filter-select"
                                        value={direction}
                                        onChange={(e) => setDirection(e.target.value)}
                                    >
                                        <option value="all">All Directions</option>
                                        <option value="UA-NL">UA-NL</option>
                                        <option value="UA-GB">UA-GB</option>
                                        <option value="UA-DE">UA-DE</option>
                                    </select>
                                    <div 
                                        id="direction-indicator"
                                        className="filter-active-indicator" 
                                        title={`Direction: ${direction}`}
                                    ></div>
                                </div>
                            </div>
                            <div className="col">
                                <label>Driver</label>
                                <div className="filter-container">
                                    <select 
                                        className="filter-select"
                                        value={driver}
                                        onChange={(e) => setDriver(e.target.value)}
                                    >
                                        <option value="all">All Drivers</option>
                                        {window.dummyData.drivers.map(driver => (
                                            <option key={driver.id} value={driver.id}>
                                                {driver.name}
                                            </option>
                                        ))}
                                    </select>
                                    <div 
                                        id="driver-indicator"
                                        className="filter-active-indicator" 
                                        title={`Driver: ${(function() {
                                            const foundDriver = window.dummyData.drivers.find(d => d.id === driver);
                                            return foundDriver ? foundDriver.name : driver;
                                        })()}`}
                                    ></div>
                                </div>
                            </div>
                            <div className="col">
                                <label>Truck</label>
                                <div className="filter-container">
                                    <select 
                                        className="filter-select"
                                        value={truck}
                                        onChange={(e) => setTruck(e.target.value)}
                                    >
                                        <option value="all">All Trucks</option>
                                        {trucks.map(truck => (
                                            <option key={truck.id} value={truck.id}>
                                                {truck.licensePlate}
                                            </option>
                                        ))}
                                    </select>
                                    <div 
                                        id="truck-indicator"
                                        className="filter-active-indicator" 
                                        title={`Truck: ${(function() {
                                            const foundTruck = trucks.find(t => t.id === truck);
                                            return foundTruck ? foundTruck.licensePlate : truck;
                                        })()}`}
                                    ></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div className="col-md-4">
                        <div className="filter-buttons d-flex justify-content-end">
                            <div className="primary-filter-buttons">
                                <button className="btn btn-primary" onClick={handleFilterChange}>
                                    Apply Filters
                                </button>
                                <button className="btn btn-outline-secondary" onClick={handleResetFilters}>
                                    Reset Filters
                                </button>
                            </div>
                            <button 
                                className="btn btn-outline-secondary graph-toggle-btn" 
                                onClick={() => setShowGraph(!showGraph)}
                            >
                                {showGraph ? 'Hide Graph' : 'Show Graph'}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            {/* Graph Section */}
            {showGraph && (
                <div className="graph-section">
                    <div className="card">
                        <div className="card-header">
                            <h5>Profit & Loss Overview</h5>
                        </div>
                        <div className="card-body">
                            <canvas id="profitLossChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
            )}
            
            {/* Trucks Overview Section */}
            <div className="trucks-section">
                <h2>Trucks Overview</h2>
                <div className="row">
                    {trucks.map(truck => (
                        <div className="col-xl-4 col-lg-6 mb-4" key={truck.id}>
                            <div className="truck-card">
                                <div className="truck-card-inner">
                                    <div className="truck-image-container">
                                        <img 
                                            src={window.placeholderImages.truck} 
                                            alt={`Truck ${truck.licensePlate}`} 
                                            className="truck-image"
                                        />
                                    </div>
                                    <div className="truck-info">
                                        <h3>{truck.licensePlate}</h3>
                                        <div className={`truck-status ${truck.status.toLowerCase()}`}>
                                            {truck.status}
                                        </div>
                                        <div className="truck-details">
                                            <div className={`detail-item ${truck.status !== 'In Trip' ? 'inactive-detail' : ''}`}>
                                                <span className="label">Driver:</span>
                                                <span className="value">{truck.currentDriver || 'Not Assigned'}</span>
                                            </div>
                                            <div className={`detail-item ${truck.status !== 'In Trip' ? 'inactive-detail' : ''}`}>
                                                <span className="label">Direction:</span>
                                                <span className="value">{truck.currentTrip && truck.currentTrip.direction || 'Not Set'}</span>
                                            </div>
                                            <div className={`detail-item ${truck.status !== 'In Trip' ? 'inactive-detail' : ''}`}>
                                                <span className="label">Cargo:</span>
                                                <span className="value">{truck.currentTrip && truck.currentTrip.cargo || 'None'}</span>
                                            </div>
                                            <div className={`detail-item ${truck.status !== 'In Trip' ? 'inactive-detail' : ''}`}>
                                                <span className="label">Trip Cost:</span>
                                                <span className="value">{truck.currentTrip && truck.currentTrip.cost || '0'} €</span>
                                            </div>
                                        </div>
                                        <a href={`/truck/${truck.id}`} className="btn btn-primary mt-2">
                                            View Details
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
};

try {
    // Render the Dashboard component
    ReactDOM.render(
        <DashboardComponent />,
        document.getElementById('dashboardRoot')
    );
} catch (error) {
    console.error("Error rendering Dashboard component:", error);
    document.getElementById('dashboardRoot').innerHTML = `
        <div class="alert alert-danger">
            <h4>Error Loading Dashboard</h4>
            <p>${error.message}</p>
        </div>
    `;
}
{% endraw %}
</script>
{% endblock %}